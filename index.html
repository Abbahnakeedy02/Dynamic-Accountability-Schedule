<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dynamic Accountability Scheduler</title>
    <style>
        :root {
            --bg: #f4f7f6;
            --missed: #e74c3c;
            --confirmed: #2ecc71;
            --pending: #3498db;
            --locked: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            font-size: 12px;
        }

        th {
            background: #2c3e50;
            color: white;
        }

        .status-box {
            height: 40px;
            padding-left: 5px;
            padding-right: 5px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: 0.3s;
        }

        .pending {
            background: var(--pending);
        }

        .confirmed {
            background: var(--confirmed);
            cursor: default;
        }

        .missed {
            background: var(--missed);
            cursor: default;
        }

        .locked {
            background: var(--locked);
            cursor: not-allowed;
        }

        .alarm-panel {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
        }

        #current-time {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e67e22;
        }

        /* Add this to your <style> section */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .alarm-panel {
                position: sticky;
                /* Keeps controls at the top while scrolling */
                top: 0;
                z-index: 1000;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                padding: 10px;
            }

            h1 {
                font-size: 1.2rem;
            }

            table {
                display: block;
                overflow-x: auto;
                /* Allows horizontal swiping for time slots */
            }

            .status-box {
                min-width: 80px;
                /* Makes boxes easier to tap on mobile */
                font-size: 10px;
                height: 35px;
            }

            button {
                width: 100%;
                /* Full-width buttons for thumbs */
                margin: 5px 0;
            }
        }
    </style>
</head>

<body>

    <h1>Weekly Task Commitment Optimizer</h1>

    <div class="alarm-panel">
        <button onclick="resetSchedule()"
            style="margin-top: 10px; padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            Reset Weekly Schedule.
        </button>
        <div
            style="margin-top: 15px; background: #eee; border-radius: 10px; height: 20px; width: 80%; margin-left: 10%; overflow: hidden;">
            <div id="progress-fill" style="width: 0%; height: 100%; background: var(--confirmed); transition: 0.5s;">
            </div>
        </div>
        <div id="stats-text" style="margin-top: 5px; font-weight: bold; font-size: 0.9rem;">Success Rate: 0%</div>
        <div>Current Time: <span id="current-time">00:00:00</span></div>
        <div id="alarm-status"> 
            <button id="startApp" onclick="initSession()"
                style="width:100%; padding:15px; background:#2ecc71; color:white; border:none; border-radius:8px; font-weight:bold; margin-bottom:10px;">
                ðŸš€ Start Session & Enable Audio
            </button> Alarm: Standby</div>
    </div>

    <div class="table-container">
        <table id="scheduleTable">
            <thead>
                <tr id="header-row">
                    <th>Time Slots</th>
                </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
        </table>
    </div>

    <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

    <script>
        const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const timeSlots = [
            "05:00-06:30", "06:30-08:00", "08:00-09:00", "09:00-12:00",
            "12:00-13:00", "13:00-15:00", "15:00-16:00", "16:00-18:00",
            "18:00-19:00", "19:00-20:00", "20:00-21:00", "21:00-23:00", "23:00-23:59"
        ];
        let isActive = false;

// 1. Combined Activation Function
function initSession() {
    const audio = document.getElementById('alarmSound');
    
    // Unlock Audio
    audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
        isActive = true;
        document.getElementById('startApp').style.display = 'none';
        document.getElementById('alarm-status').innerText = "Alarm: Ready";
    }).catch(e => alert("Please tap again to enable audio."));

    // Request Notification Permission
    if ("Notification" in window) {
        Notification.requestPermission();
    }
}

// 2. Reliable Mobile Notifications
function sendNotification(taskName) {
    if (Notification.permission === "granted") {
        // Mobile browsers prefer showing notifications via the Service Worker
        navigator.serviceWorker.ready.then(registration => {
            registration.showNotification("Task Reminder", {
                body: `Time for: ${taskName}`,
                icon: "https://cdn-icons-png.flaticon.com/512/311/311101.png",
                vibrate: [200, 100, 200]
            });
        });
    }
}
    
        function confirmTask(id) {
            // UNLOCK AUDIO: This allows the alarm to ring later automatically
            const audio = document.getElementById('alarmSound');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
            }).catch(e => console.log("Audio waiting for interaction"));

            // ... rest of your existing function code ...
        }
        function unlockAudio() {
            const audio = document.getElementById('alarmSound');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                document.getElementById('enable-audio').style.display = 'none'; // Hide button once enabled
                alert("Audio enabled! Alarms will now sound automatically.");
            });
        }
        // Initialize State
        let scheduleState = JSON.parse(localStorage.getItem('scheduleState')) || {};

        function initTable() {
            const header = document.getElementById('header-row');
            const body = document.getElementById('table-body');

            // Create Headers
            timeSlots.forEach(slot => {
                let th = document.createElement('th');
                th.innerHTML = `Slot<br>${slot}`;
                header.appendChild(th);
            });

            // Create Rows
            days.forEach((day, dIdx) => {
                let tr = document.createElement('tr');
                let dayCell = document.createElement('td');
                dayCell.innerHTML = `<b>${day}</b>`;
                tr.appendChild(dayCell);

                timeSlots.forEach((slot, sIdx) => {
                    let td = document.createElement('td');
                    let cellId = `${dIdx}-${sIdx}`;
                    let status = scheduleState[cellId] || 'pending';

                    td.innerHTML = `<div id="${cellId}" class="status-box ${status}" onclick="confirmTask('${cellId}')">${status.toUpperCase()}</div>`;
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
            // Check if the last saved reset date was a different week
            const lastReset = localStorage.getItem('lastResetDate');
            const today = new Date().toDateString();

            if (lastReset !== today && new Date().getDay() === 6) { // 6 is Saturday
                localStorage.removeItem('scheduleState');
                localStorage.setItem('lastResetDate', today);
                scheduleState = {};
            }
            updateProgress();
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0];
            document.getElementById('current-time').innerText = timeStr;
            checkLogic(now);
        }

        function checkLogic(now) {
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            const dayIdx = (now.getDay() + 1) % 7; // Adjusting JS Sunday=0 to match Saturday start

            timeSlots.forEach((slot, sIdx) => {
                const [start, end] = slot.split('-');
                const [sh, sm] = start.split(':').map(Number);
                const [eh, em] = end.split(':').map(Number);

                const startTimeVal = sh * 60 + sm;
                const endTimeVal = eh * 60 + em;
                const nowTimeVal = currentHour * 60 + currentMin;

                // Adjust for overnight shift (23:00-05:00)
                let isCurrentInterval = false;
                if (sh > eh) { // Overnight case
                    isCurrentInterval = (nowTimeVal >= startTimeVal || nowTimeVal < endTimeVal);
                } else {
                    isCurrentInterval = (nowTimeVal >= startTimeVal && nowTimeVal < endTimeVal);
                }
                // Find this block in checkLogic and replace it:
if (nowTimeVal === startTimeVal && now.getSeconds() < 2 && isActive) {
    const alarm = document.getElementById('alarmSound');
    let playCount = 0;

    const playSequence = () => {
        if (playCount < 3) {
            alarm.play();
            playCount++;
            document.getElementById('alarm-status').innerText = ALARM RINGING (${playCount}/3);
        } else {
            alarm.removeEventListener('ended', playSequence);
            document.getElementById('alarm-status').innerText = "Alarm: Standby";
        }
    };

    alarm.addEventListener('ended', playSequence);
    playSequence(); // Start first play
    sendNotification(timeSlots[sIdx]); // Trigger notification
}
                const cellId = `${dayIdx}-${sIdx}`;
                const element = document.getElementById(cellId);

                if (!element) return;

                // Missed Logic: If time has passed and not confirmed
                let hasPassed = false;
                if (sh < eh) {
                    if (nowTimeVal > endTimeVal) hasPassed = true;
                } else {
                    if (nowTimeVal > endTimeVal && nowTimeVal < startTimeVal) hasPassed = true;
                }

                if (hasPassed && scheduleState[cellId] !== 'confirmed' && scheduleState[cellId] !== 'missed') {
                    handleMissed(cellId, dayIdx, sIdx);
                }

                // Ring Alarm at start of interval
                if (nowTimeVal === startTimeVal && now.getSeconds() < 2) {
                    document.getElementById('alarmSound').play();
                    document.getElementById('alarm-status').innerText = "ALARM RINGING!";
                    setTimeout(() => document.getElementById('alarm-status').innerText = "Standby", 5000);
                }
            });
        }

        function confirmTask(id) {
            const [dIdx, sIdx] = id.split('-').map(Number);
            const now = new Date();
            const nowTimeVal = now.getHours() * 60 + now.getMinutes();
            const [start, end] = timeSlots[sIdx].split('-');
            const [sh, sm] = start.split(':').map(Number);
            const startTimeVal = sh * 60 + sm;
            const [eh, em] = end.split(':').map(Number);
            const endTimeVal = eh * 60 + em;
            const todayIdx = (now.getDay() + 1) % 7; // Matching your Saturday-start logic

            // Constraint: Only confirm during the interval
            let isActive = (nowTimeVal >= startTimeVal && nowTimeVal < endTimeVal);
            if (sh > eh) isActive = (nowTimeVal >= startTimeVal || nowTimeVal < endTimeVal);
            if (dIdx !== todayIdx) {
                alert("You can only check tasks for today!");
                return;
            } else {
                if (isActive && scheduleState[id] !== 'missed') {
                    updateCell(id, 'confirmed');
                } else {
                    alert("You can only confirm during the active time slot!");
                }
            }

        }

        function handleMissed(id, dIdx, sIdx) {
            updateCell(id, 'missed');

            // Friday Logic: Move to Friday (dIdx 6) at same time slot
            if (dIdx < 6) {
                const fridayId = `6-${sIdx}`;
                const currentFridayStatus = scheduleState[fridayId];

                if (currentFridayStatus === 'confirmed') {
                    // If Friday is already confirmed, move to "Worse case" (next slot)
                    const nextSlotId = `${dIdx}-${(sIdx + 1) % 13}`;
                    console.log(`Task ${id} moved to next slot due to failure.`);
                } else {
                    // Sent to Friday / Merge
                    console.log(`Task ${id} moved to Friday slot ${sIdx}`);
                    const friElem = document.getElementById(fridayId);
                    if (friElem) friElem.innerText = "MERGED/PENDING";
                }
            }
        }

        function updateCell(id, status) {
            scheduleState[id] = status;
            const el = document.getElementById(id);
            el.className = `status-box ${status}`;
            el.innerText = status.toUpperCase();
            localStorage.setItem('scheduleState', JSON.stringify(scheduleState));
            updateProgress();
        }
        function resetSchedule() {
            if (confirm("Are you sure you want to reset the entire week? All progress will be lost.")) {
                // 1. Clear LocalStorage
                localStorage.removeItem('scheduleState');

                // 2. Reset the internal state variable
                scheduleState = {};

                // 3. Update the UI - Refresh all status boxes back to 'pending'
                const boxes = document.querySelectorAll('.status-box');
                boxes.forEach(box => {
                    box.className = 'status-box pending';
                    box.innerText = 'PENDING';
                });

                alert("Schedule has been reset!");
            }
        }

        function updateProgress() {
            const now = new Date();
            const todayIdx = (now.getDay() + 1) % 7;

            // Get all cells for today (IDs starting with today's index)
            let totalTasks = timeSlots.length;
            let confirmedCount = 0;
            let missedCount = 0;

            for (let sIdx = 0; sIdx < timeSlots.length; sIdx++) {
                const status = scheduleState[`${todayIdx}-${sIdx}`];
                if (status === 'confirmed') confirmedCount++;
                if (status === 'missed') missedCount++;
            }

            // Calculate percentage (Confirmed vs Total possible)
            const percentage = Math.round((confirmedCount / totalTasks) * 100);

            // Update UI
            const fill = document.getElementById('progress-fill');
            fill.style.width = percentage + "%";
            document.getElementById('stats-text').innerText =
                `Today's Progress: ${percentage}% (${confirmedCount} Done, ${missedCount} Missed)`;
        }

        initTable();
        setInterval(updateClock, 1000);
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log("Offline mode active!"))
                .catch(err => console.log("Offline mode failed: ", err));
        }

    </script>
</body>


</html>


